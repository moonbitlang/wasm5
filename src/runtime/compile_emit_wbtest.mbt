///|
fn compile_module_types() -> Array[@core.TypeDef] {
  let type0 : @core.TypeDef = Func({ params: [I32, I64], results: [I32] })
  let type1 : @core.TypeDef = Func({ params: [], results: [I32] })
  let type2 : @core.TypeDef = Func({ params: [], results: [] })
  [type0, type1, type2]
}

///|
fn build_compile_instrs() -> Array[@core.Instr] {
  let instrs : Array[@core.Instr] = []
  instrs.push(Unreachable)
  instrs.push(Nop)
  instrs.push(Block(Empty, []))
  instrs.push(Loop(Empty, []))
  instrs.push(If(Empty, [], []))
  instrs.push(Br(0U))
  instrs.push(BrIf(0U))
  instrs.push(BrTable([0U], 0U))
  instrs.push(BrOnNull(0U))
  instrs.push(BrOnNonNull(0U))
  instrs.push(Return)
  instrs.push(Call(0U))
  instrs.push(CallIndirect(0U, 0U))
  instrs.push(ReturnCall(0U))
  instrs.push(ReturnCallIndirect(0U, 0U))
  instrs.push(CallRef(0U))
  instrs.push(ReturnCallRef(0U))
  instrs.push(Drop)
  instrs.push(Select)
  instrs.push(SelectTyped([I32]))
  instrs.push(LocalGet(0U))
  instrs.push(LocalSet(0U))
  instrs.push(LocalTee(0U))
  instrs.push(GlobalGet(0U))
  instrs.push(GlobalSet(0U))
  instrs.push(I32Load(0U, 0U, 0U))
  instrs.push(I64Load(0U, 0U, 0U))
  instrs.push(F32Load(0U, 0U, 0U))
  instrs.push(F64Load(0U, 0U, 0U))
  instrs.push(I32Load8S(0U, 0U, 0U))
  instrs.push(I32Load8U(0U, 0U, 0U))
  instrs.push(I32Load16S(0U, 0U, 0U))
  instrs.push(I32Load16U(0U, 0U, 0U))
  instrs.push(I64Load8S(0U, 0U, 0U))
  instrs.push(I64Load8U(0U, 0U, 0U))
  instrs.push(I64Load16S(0U, 0U, 0U))
  instrs.push(I64Load16U(0U, 0U, 0U))
  instrs.push(I64Load32S(0U, 0U, 0U))
  instrs.push(I64Load32U(0U, 0U, 0U))
  instrs.push(I32Store(0U, 0U, 0U))
  instrs.push(I64Store(0U, 0U, 0U))
  instrs.push(F32Store(0U, 0U, 0U))
  instrs.push(F64Store(0U, 0U, 0U))
  instrs.push(I32Store8(0U, 0U, 0U))
  instrs.push(I32Store16(0U, 0U, 0U))
  instrs.push(I64Store8(0U, 0U, 0U))
  instrs.push(I64Store16(0U, 0U, 0U))
  instrs.push(I64Store32(0U, 0U, 0U))
  instrs.push(MemorySize(0U))
  instrs.push(MemoryGrow(0U))
  instrs.push(TableGet(0U))
  instrs.push(TableSet(0U))
  instrs.push(TableSize(0U))
  instrs.push(TableGrow(0U))
  instrs.push(TableInit(0U, 0U))
  instrs.push(TableCopy(0U, 0U))
  instrs.push(TableFill(0U))
  instrs.push(ElemDrop(0U))
  instrs.push(MemoryInit(0U, 0U))
  instrs.push(DataDrop(0U))
  instrs.push(MemoryCopy(0U, 0U))
  instrs.push(MemoryFill(0U))
  instrs.push(RefNull(Func))
  instrs.push(RefFunc(0U))
  instrs.push(RefIsNull)
  instrs.push(RefEq)
  instrs.push(RefAsNonNull)
  instrs.push(I32Const(0U))
  instrs.push(I64Const(0UL))
  instrs.push(F32Const(0.0))
  instrs.push(F64Const(0.0))
  instrs.push(I32Eqz)
  instrs.push(I32Eq)
  instrs.push(I32Ne)
  instrs.push(I32LtS)
  instrs.push(I32LtU)
  instrs.push(I32GtS)
  instrs.push(I32GtU)
  instrs.push(I32LeS)
  instrs.push(I32LeU)
  instrs.push(I32GeS)
  instrs.push(I32GeU)
  instrs.push(I32Clz)
  instrs.push(I32Ctz)
  instrs.push(I32Popcnt)
  instrs.push(I32Add)
  instrs.push(I32Sub)
  instrs.push(I32Mul)
  instrs.push(I32DivS)
  instrs.push(I32DivU)
  instrs.push(I32RemS)
  instrs.push(I32RemU)
  instrs.push(I32And)
  instrs.push(I32Or)
  instrs.push(I32Xor)
  instrs.push(I32Shl)
  instrs.push(I32ShrS)
  instrs.push(I32ShrU)
  instrs.push(I32Rotl)
  instrs.push(I32Rotr)
  instrs.push(I64Eqz)
  instrs.push(I64Eq)
  instrs.push(I64Ne)
  instrs.push(I64LtS)
  instrs.push(I64LtU)
  instrs.push(I64GtS)
  instrs.push(I64GtU)
  instrs.push(I64LeS)
  instrs.push(I64LeU)
  instrs.push(I64GeS)
  instrs.push(I64GeU)
  instrs.push(I64Clz)
  instrs.push(I64Ctz)
  instrs.push(I64Popcnt)
  instrs.push(I64Add)
  instrs.push(I64Sub)
  instrs.push(I64Mul)
  instrs.push(I64DivS)
  instrs.push(I64DivU)
  instrs.push(I64RemS)
  instrs.push(I64RemU)
  instrs.push(I64And)
  instrs.push(I64Or)
  instrs.push(I64Xor)
  instrs.push(I64Shl)
  instrs.push(I64ShrS)
  instrs.push(I64ShrU)
  instrs.push(I64Rotl)
  instrs.push(I64Rotr)
  instrs.push(F32Eq)
  instrs.push(F32Ne)
  instrs.push(F32Lt)
  instrs.push(F32Gt)
  instrs.push(F32Le)
  instrs.push(F32Ge)
  instrs.push(F32Abs)
  instrs.push(F32Neg)
  instrs.push(F32Ceil)
  instrs.push(F32Floor)
  instrs.push(F32Trunc)
  instrs.push(F32Nearest)
  instrs.push(F32Sqrt)
  instrs.push(F32Add)
  instrs.push(F32Sub)
  instrs.push(F32Mul)
  instrs.push(F32Div)
  instrs.push(F32Min)
  instrs.push(F32Max)
  instrs.push(F32Copysign)
  instrs.push(F64Eq)
  instrs.push(F64Ne)
  instrs.push(F64Lt)
  instrs.push(F64Gt)
  instrs.push(F64Le)
  instrs.push(F64Ge)
  instrs.push(F64Abs)
  instrs.push(F64Neg)
  instrs.push(F64Ceil)
  instrs.push(F64Floor)
  instrs.push(F64Trunc)
  instrs.push(F64Nearest)
  instrs.push(F64Sqrt)
  instrs.push(F64Add)
  instrs.push(F64Sub)
  instrs.push(F64Mul)
  instrs.push(F64Div)
  instrs.push(F64Min)
  instrs.push(F64Max)
  instrs.push(F64Copysign)
  instrs.push(I32WrapI64)
  instrs.push(I32TruncF32S)
  instrs.push(I32TruncF32U)
  instrs.push(I32TruncF64S)
  instrs.push(I32TruncF64U)
  instrs.push(I64ExtendI32S)
  instrs.push(I64ExtendI32U)
  instrs.push(I64TruncF32S)
  instrs.push(I64TruncF32U)
  instrs.push(I64TruncF64S)
  instrs.push(I64TruncF64U)
  instrs.push(F32ConvertI32S)
  instrs.push(F32ConvertI32U)
  instrs.push(F32ConvertI64S)
  instrs.push(F32ConvertI64U)
  instrs.push(F32DemoteF64)
  instrs.push(F64ConvertI32S)
  instrs.push(F64ConvertI32U)
  instrs.push(F64ConvertI64S)
  instrs.push(F64ConvertI64U)
  instrs.push(F64PromoteF32)
  instrs.push(I32ReinterpretF32)
  instrs.push(I64ReinterpretF64)
  instrs.push(F32ReinterpretI32)
  instrs.push(F64ReinterpretI64)
  instrs.push(I32Extend8S)
  instrs.push(I32Extend16S)
  instrs.push(I64Extend8S)
  instrs.push(I64Extend16S)
  instrs.push(I64Extend32S)
  instrs.push(I32TruncSatF32S)
  instrs.push(I32TruncSatF32U)
  instrs.push(I32TruncSatF64S)
  instrs.push(I32TruncSatF64U)
  instrs.push(I64TruncSatF32S)
  instrs.push(I64TruncSatF32U)
  instrs.push(I64TruncSatF64S)
  instrs.push(I64TruncSatF64U)
  instrs.push(Block(Value(I32), []))
  instrs.push(Block(TypeIndex(0), []))
  instrs.push(Loop(Value(I32), []))
  instrs.push(If(Value(I32), [], []))
  instrs.push(RefNull(Extern))
  instrs.push(RefNull(Any))
  instrs.push(RefNull(Eq))
  instrs.push(RefNull(I31))
  instrs.push(RefNull(Struct))
  instrs.push(RefNull(Array))
  instrs.push(RefNull(Exn))
  instrs.push(RefNull(None))
  instrs.push(RefNull(NoFunc))
  instrs.push(RefNull(NoExtern))
  instrs.push(RefNull(NoExn))
  instrs.push(RefNull(TypeIndex(0)))
  instrs
}

///|
fn make_compile_module(instrs : Array[@core.Instr]) -> @core.Module {
  let types = compile_module_types()
  let code : @core.Code = {
    locals: [I32],
    body: @core.Expr::{ instrs, },
    compiled: None,
  }
  @core.Module::{
    types,
    type_groups: [],
    customs: [],
    funcs: [0U],
    tables: [],
    mems: [],
    globals: [],
    tags: [],
    elems: [],
    datas: [],
    start: None,
    imports: [],
    exports: [],
    codes: [code],
  }
}

///|
test "compile emit covers instructions" {
  let instrs = build_compile_instrs()
  let module_ = make_compile_module(instrs)
  let runtime = Runtime::load(module_)
  runtime.compile()
  assert_eq(runtime.ops.length() > 0, true)
}
