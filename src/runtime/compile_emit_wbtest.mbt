///|
fn compile_module_types() -> Array[@core.FuncType] {
  let type0 : @core.FuncType = {
    params: [@core.ValType::I32, @core.ValType::I64],
    results: [@core.ValType::I32],
  }
  let type1 : @core.FuncType = { params: [], results: [@core.ValType::I32] }
  let type2 : @core.FuncType = { params: [], results: [] }
  [type0, type1, type2]
}

///|
fn build_compile_instrs() -> Array[@core.Instr] {
  let instrs : Array[@core.Instr] = []
  instrs.push(@core.Instr::Unreachable)
  instrs.push(@core.Instr::Nop)
  instrs.push(@core.Instr::Block(@core.BlockType::Empty, []))
  instrs.push(@core.Instr::Loop(@core.BlockType::Empty, []))
  instrs.push(@core.Instr::If(@core.BlockType::Empty, [], []))
  instrs.push(@core.Instr::Br(0U))
  instrs.push(@core.Instr::BrIf(0U))
  instrs.push(@core.Instr::BrTable([0U], 0U))
  instrs.push(@core.Instr::BrOnNull(0U))
  instrs.push(@core.Instr::BrOnNonNull(0U))
  instrs.push(@core.Instr::Return)
  instrs.push(@core.Instr::Call(0U))
  instrs.push(@core.Instr::CallIndirect(0U, 0U))
  instrs.push(@core.Instr::ReturnCall(0U))
  instrs.push(@core.Instr::ReturnCallIndirect(0U, 0U))
  instrs.push(@core.Instr::CallRef(0U))
  instrs.push(@core.Instr::ReturnCallRef(0U))
  instrs.push(@core.Instr::Drop)
  instrs.push(@core.Instr::Select)
  instrs.push(@core.Instr::SelectTyped([@core.ValType::I32]))
  instrs.push(@core.Instr::LocalGet(0U))
  instrs.push(@core.Instr::LocalSet(0U))
  instrs.push(@core.Instr::LocalTee(0U))
  instrs.push(@core.Instr::GlobalGet(0U))
  instrs.push(@core.Instr::GlobalSet(0U))
  instrs.push(@core.Instr::I32Load(0U, 0U))
  instrs.push(@core.Instr::I64Load(0U, 0U))
  instrs.push(@core.Instr::F32Load(0U, 0U))
  instrs.push(@core.Instr::F64Load(0U, 0U))
  instrs.push(@core.Instr::I32Load8S(0U, 0U))
  instrs.push(@core.Instr::I32Load8U(0U, 0U))
  instrs.push(@core.Instr::I32Load16S(0U, 0U))
  instrs.push(@core.Instr::I32Load16U(0U, 0U))
  instrs.push(@core.Instr::I64Load8S(0U, 0U))
  instrs.push(@core.Instr::I64Load8U(0U, 0U))
  instrs.push(@core.Instr::I64Load16S(0U, 0U))
  instrs.push(@core.Instr::I64Load16U(0U, 0U))
  instrs.push(@core.Instr::I64Load32S(0U, 0U))
  instrs.push(@core.Instr::I64Load32U(0U, 0U))
  instrs.push(@core.Instr::I32Store(0U, 0U))
  instrs.push(@core.Instr::I64Store(0U, 0U))
  instrs.push(@core.Instr::F32Store(0U, 0U))
  instrs.push(@core.Instr::F64Store(0U, 0U))
  instrs.push(@core.Instr::I32Store8(0U, 0U))
  instrs.push(@core.Instr::I32Store16(0U, 0U))
  instrs.push(@core.Instr::I64Store8(0U, 0U))
  instrs.push(@core.Instr::I64Store16(0U, 0U))
  instrs.push(@core.Instr::I64Store32(0U, 0U))
  instrs.push(@core.Instr::MemorySize(0U))
  instrs.push(@core.Instr::MemoryGrow(0U))
  instrs.push(@core.Instr::TableGet(0U))
  instrs.push(@core.Instr::TableSet(0U))
  instrs.push(@core.Instr::TableSize(0U))
  instrs.push(@core.Instr::TableGrow(0U))
  instrs.push(@core.Instr::TableInit(0U, 0U))
  instrs.push(@core.Instr::TableCopy(0U, 0U))
  instrs.push(@core.Instr::ElemDrop(0U))
  instrs.push(@core.Instr::MemoryInit(0U))
  instrs.push(@core.Instr::DataDrop(0U))
  instrs.push(@core.Instr::MemoryCopy)
  instrs.push(@core.Instr::MemoryFill)
  instrs.push(@core.Instr::RefNull(@core.RefType::Func))
  instrs.push(@core.Instr::RefFunc(0U))
  instrs.push(@core.Instr::RefIsNull)
  instrs.push(@core.Instr::I32Const(0U))
  instrs.push(@core.Instr::I64Const(0UL))
  instrs.push(@core.Instr::F32Const(0.0))
  instrs.push(@core.Instr::F64Const(0.0))
  instrs.push(@core.Instr::I32Eqz)
  instrs.push(@core.Instr::I32Eq)
  instrs.push(@core.Instr::I32Ne)
  instrs.push(@core.Instr::I32LtS)
  instrs.push(@core.Instr::I32LtU)
  instrs.push(@core.Instr::I32GtS)
  instrs.push(@core.Instr::I32GtU)
  instrs.push(@core.Instr::I32LeS)
  instrs.push(@core.Instr::I32LeU)
  instrs.push(@core.Instr::I32GeS)
  instrs.push(@core.Instr::I32GeU)
  instrs.push(@core.Instr::I32Clz)
  instrs.push(@core.Instr::I32Ctz)
  instrs.push(@core.Instr::I32Popcnt)
  instrs.push(@core.Instr::I32Add)
  instrs.push(@core.Instr::I32Sub)
  instrs.push(@core.Instr::I32Mul)
  instrs.push(@core.Instr::I32DivS)
  instrs.push(@core.Instr::I32DivU)
  instrs.push(@core.Instr::I32RemS)
  instrs.push(@core.Instr::I32RemU)
  instrs.push(@core.Instr::I32And)
  instrs.push(@core.Instr::I32Or)
  instrs.push(@core.Instr::I32Xor)
  instrs.push(@core.Instr::I32Shl)
  instrs.push(@core.Instr::I32ShrS)
  instrs.push(@core.Instr::I32ShrU)
  instrs.push(@core.Instr::I32Rotl)
  instrs.push(@core.Instr::I32Rotr)
  instrs.push(@core.Instr::I64Eqz)
  instrs.push(@core.Instr::I64Eq)
  instrs.push(@core.Instr::I64Ne)
  instrs.push(@core.Instr::I64LtS)
  instrs.push(@core.Instr::I64LtU)
  instrs.push(@core.Instr::I64GtS)
  instrs.push(@core.Instr::I64GtU)
  instrs.push(@core.Instr::I64LeS)
  instrs.push(@core.Instr::I64LeU)
  instrs.push(@core.Instr::I64GeS)
  instrs.push(@core.Instr::I64GeU)
  instrs.push(@core.Instr::I64Clz)
  instrs.push(@core.Instr::I64Ctz)
  instrs.push(@core.Instr::I64Popcnt)
  instrs.push(@core.Instr::I64Add)
  instrs.push(@core.Instr::I64Sub)
  instrs.push(@core.Instr::I64Mul)
  instrs.push(@core.Instr::I64DivS)
  instrs.push(@core.Instr::I64DivU)
  instrs.push(@core.Instr::I64RemS)
  instrs.push(@core.Instr::I64RemU)
  instrs.push(@core.Instr::I64And)
  instrs.push(@core.Instr::I64Or)
  instrs.push(@core.Instr::I64Xor)
  instrs.push(@core.Instr::I64Shl)
  instrs.push(@core.Instr::I64ShrS)
  instrs.push(@core.Instr::I64ShrU)
  instrs.push(@core.Instr::I64Rotl)
  instrs.push(@core.Instr::I64Rotr)
  instrs.push(@core.Instr::F32Eq)
  instrs.push(@core.Instr::F32Ne)
  instrs.push(@core.Instr::F32Lt)
  instrs.push(@core.Instr::F32Gt)
  instrs.push(@core.Instr::F32Le)
  instrs.push(@core.Instr::F32Ge)
  instrs.push(@core.Instr::F32Abs)
  instrs.push(@core.Instr::F32Neg)
  instrs.push(@core.Instr::F32Ceil)
  instrs.push(@core.Instr::F32Floor)
  instrs.push(@core.Instr::F32Trunc)
  instrs.push(@core.Instr::F32Nearest)
  instrs.push(@core.Instr::F32Sqrt)
  instrs.push(@core.Instr::F32Add)
  instrs.push(@core.Instr::F32Sub)
  instrs.push(@core.Instr::F32Mul)
  instrs.push(@core.Instr::F32Div)
  instrs.push(@core.Instr::F32Min)
  instrs.push(@core.Instr::F32Max)
  instrs.push(@core.Instr::F32Copysign)
  instrs.push(@core.Instr::F64Eq)
  instrs.push(@core.Instr::F64Ne)
  instrs.push(@core.Instr::F64Lt)
  instrs.push(@core.Instr::F64Gt)
  instrs.push(@core.Instr::F64Le)
  instrs.push(@core.Instr::F64Ge)
  instrs.push(@core.Instr::F64Abs)
  instrs.push(@core.Instr::F64Neg)
  instrs.push(@core.Instr::F64Ceil)
  instrs.push(@core.Instr::F64Floor)
  instrs.push(@core.Instr::F64Trunc)
  instrs.push(@core.Instr::F64Nearest)
  instrs.push(@core.Instr::F64Sqrt)
  instrs.push(@core.Instr::F64Add)
  instrs.push(@core.Instr::F64Sub)
  instrs.push(@core.Instr::F64Mul)
  instrs.push(@core.Instr::F64Div)
  instrs.push(@core.Instr::F64Min)
  instrs.push(@core.Instr::F64Max)
  instrs.push(@core.Instr::F64Copysign)
  instrs.push(@core.Instr::I32WrapI64)
  instrs.push(@core.Instr::I32TruncF32S)
  instrs.push(@core.Instr::I32TruncF32U)
  instrs.push(@core.Instr::I32TruncF64S)
  instrs.push(@core.Instr::I32TruncF64U)
  instrs.push(@core.Instr::I64ExtendI32S)
  instrs.push(@core.Instr::I64ExtendI32U)
  instrs.push(@core.Instr::I64TruncF32S)
  instrs.push(@core.Instr::I64TruncF32U)
  instrs.push(@core.Instr::I64TruncF64S)
  instrs.push(@core.Instr::I64TruncF64U)
  instrs.push(@core.Instr::F32ConvertI32S)
  instrs.push(@core.Instr::F32ConvertI32U)
  instrs.push(@core.Instr::F32ConvertI64S)
  instrs.push(@core.Instr::F32ConvertI64U)
  instrs.push(@core.Instr::F32DemoteF64)
  instrs.push(@core.Instr::F64ConvertI32S)
  instrs.push(@core.Instr::F64ConvertI32U)
  instrs.push(@core.Instr::F64ConvertI64S)
  instrs.push(@core.Instr::F64ConvertI64U)
  instrs.push(@core.Instr::F64PromoteF32)
  instrs.push(@core.Instr::I32ReinterpretF32)
  instrs.push(@core.Instr::I64ReinterpretF64)
  instrs.push(@core.Instr::F32ReinterpretI32)
  instrs.push(@core.Instr::F64ReinterpretI64)
  instrs.push(@core.Instr::I32Extend8S)
  instrs.push(@core.Instr::I32Extend16S)
  instrs.push(@core.Instr::I64Extend8S)
  instrs.push(@core.Instr::I64Extend16S)
  instrs.push(@core.Instr::I64Extend32S)
  instrs.push(@core.Instr::I32TruncSatF32S)
  instrs.push(@core.Instr::I32TruncSatF32U)
  instrs.push(@core.Instr::I32TruncSatF64S)
  instrs.push(@core.Instr::I32TruncSatF64U)
  instrs.push(@core.Instr::I64TruncSatF32S)
  instrs.push(@core.Instr::I64TruncSatF32U)
  instrs.push(@core.Instr::I64TruncSatF64S)
  instrs.push(@core.Instr::I64TruncSatF64U)
  instrs.push(
    @core.Instr::Block(@core.BlockType::Value(@core.ValType::I32), []),
  )
  instrs.push(@core.Instr::Block(@core.BlockType::TypeIndex(0), []))
  instrs.push(@core.Instr::Loop(@core.BlockType::Value(@core.ValType::I32), []))
  instrs.push(
    @core.Instr::If(@core.BlockType::Value(@core.ValType::I32), [], []),
  )
  instrs.push(@core.Instr::RefNull(@core.RefType::Extern))
  instrs.push(@core.Instr::RefNull(@core.RefType::Any))
  instrs.push(@core.Instr::RefNull(@core.RefType::Eq))
  instrs.push(@core.Instr::RefNull(@core.RefType::I31))
  instrs.push(@core.Instr::RefNull(@core.RefType::Struct))
  instrs.push(@core.Instr::RefNull(@core.RefType::Array))
  instrs.push(@core.Instr::RefNull(@core.RefType::Exn))
  instrs.push(@core.Instr::RefNull(@core.RefType::None))
  instrs.push(@core.Instr::RefNull(@core.RefType::NoFunc))
  instrs.push(@core.Instr::RefNull(@core.RefType::NoExtern))
  instrs.push(@core.Instr::RefNull(@core.RefType::NoExn))
  instrs.push(@core.Instr::RefNull(@core.RefType::TypeIndex(0)))
  instrs
}

///|
fn make_compile_module(instrs : Array[@core.Instr]) -> @core.Module {
  let types = compile_module_types()
  let code : @core.Code = {
    locals: [@core.ValType::I32],
    body: @core.Expr::{ instrs, },
    compiled: None,
  }
  @core.Module::{
    types,
    funcs: [0U],
    tables: [],
    mems: [],
    globals: [],
    elems: [],
    datas: [],
    start: None,
    imports: [],
    exports: [],
    codes: [code],
  }
}

///|
test "compile emit covers instructions" {
  let instrs = build_compile_instrs()
  let module_ = make_compile_module(instrs)
  let runtime = Runtime::load(module_)
  runtime.compile()
  assert_eq(runtime.ops.length() > 0, true)
}
